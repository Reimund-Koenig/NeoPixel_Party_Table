<html>
	<head>
		<title>Controller</title>
		<meta charset="utf-8">
		<link rel="stylesheet" type="text/css" href="/stylesheet.css">
		<link rel="shortcut icon" href="/favicon.ico">
		<meta name="description" content="Web controller for LED table">
		<meta name="author" content="Reimund KÃ¶nig">
		<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
		<meta name="keywords" lang="de" content="virtual, controller, joystick">
	</head>
	<body>
		<div id="login">
			
			<div class="wrongUsername">
					<div class="wrongUsernameText">
					</div>
				</div>
			<form action="">
				<input type="text" autocomplete="off" class="inputLogin" id="new_player" maxlength="25" placeholder="Username"><br>
				<input class="btn btnLogin btnBlue" type="submit" value="Abschicken">
			</form> 
		</div>
		<div id="controller">
			<section id="main"></section>
		</div>
		<script src="/virtualjoystick.js"></script>
		<script src="https://cdn.socket.io/socket.io-1.2.0.js"></script>
		<script src="https://code.jquery.com/jquery-1.11.1.js"></script>
		<script>
			console.log("touchscreen is", VirtualJoystick.touchScreenAvailable() ? "available" : "not available");
		</script>
		<script>
			var username = "";		
			var socket = io();
			var socket_id = "";
			console.log(socket);
			$(function () {
				$('form').submit(function(){
					console.log("Send Message: " + $('#new_player').val())
					socket.emit("new_player", $('#new_player').val());
					return false;
				});
				socket.on('connected', function(id) {
					if(socket_id == "") {
						socket_id = id;
					}
					console.log("Connected to Table with id: " + id)
				});
				socket.on('start', function(id, name){
					if(id != socket_id) { return; }
					console.log("Username: " + name);
					username = name;
					document.getElementById("controller").style.display = "block";
					document.getElementById("login").style.display = "none";
				});
				socket.on('disconnect', () => {
					document.getElementById("controller").style.display = "none";
					document.getElementById("login").style.display = "block";
					socket_id = "";
				});
			});	
		</script>
		<script>
			var lastPositionLeft = "None"
			var lastPositionRight = "None"

			var joystick_right	= new VirtualJoystick({
				container	: document.getElementById('main'),
				mouseSupport	: false,
				strokeStyle	: 'cyan',
				limitStickTravel: true,
				stickRadius	: 120		
			});
			joystick_right.addEventListener('touchStartValidation', function(event){
				var touch	= event.changedTouches[0];
				if( touch.pageX < window.innerWidth/2 )	return false;
				return true
			});
			
			joystick_right.addEventListener('touchStart', function(event){
				socket.emit("right", "push", username);
			})

			joystick_right.addEventListener('touchEnd', function(event){
				// socket.emit("test", "touchEnd right " + lastPositionRight);
				socket.emit("right", lastPositionRight, username);
			})
			
			// one on the right of the screen
			var joystick_left	= new VirtualJoystick({
				container	:	document.getElementById('main'),
				mouseSupport	: false,
				strokeStyle	: 'orange',
				limitStickTravel: true,
				stickRadius	: 120		
			});

			joystick_left.addEventListener('touchStartValidation', function(event){
				var touch	= event.changedTouches[0];
				if( touch.pageX >= window.innerWidth/2 )	return false;
				return true
			});

			joystick_left.addEventListener('touchStart', function(event){
				socket.emit("left", "push", username);
			})

			joystick_left.addEventListener('touchEnd', function(event){
				socket.emit("left", lastPositionLeft, username);
			})

			setInterval(function(){
				if(joystick_left.up()) lastPositionLeft = "up";
				if(joystick_left.down()) lastPositionLeft = "down";
				if(joystick_left.left()) lastPositionLeft = "left";
				if(joystick_left.right()) lastPositionLeft = "right";

				if(joystick_right.up()) lastPositionRight = "up";
				if(joystick_right.down()) lastPositionRight = "down";
				if(joystick_right.left()) lastPositionRight = "left";
				if(joystick_right.right()) lastPositionRight = "right";
			}, 20);


		</script>
	</body>
</html>